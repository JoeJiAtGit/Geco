<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <GecoDir Condition="'$(GecoDir)' == ''">$(SolutionDir)Geco\</GecoDir>
    <OverwriteSettings Condition="'$(OverwriteSettings)' == ''">false</OverwriteSettings>
  </PropertyGroup>

  <ItemGroup>
    <Compile Remove="**\*.cs" />
    <None Include="**\*.cs" />
  </ItemGroup>

  <Target BeforeTargets="BeforeBuild" Name="DotNetNewTemplatePackage">
    <PropertyGroup>
      <GecoTargetDir>$(ProjectDir)\Template\Content\</GecoTargetDir>
    </PropertyGroup>
    
    <ItemGroup>
      <TemplateFiles Include="$(GecoDir)appsettings.json" Condition="'$(OverwriteSettings)' == 'true'"/>
      <TemplateFiles Include="$(GecoDir)**\*.cs" Exclude="$(GecoDir)obj\**\*.*"/>
      <TemplateFiles Include="$(GecoDir)Program.cs" />
      <TemplateFiles Include="$(GecoDir)Geco.csproj;$(GecoDir)Geco.Targets" />
    </ItemGroup>
    
    <Copy SourceFiles="@(TemplateFiles)" DestinationFolder="$(GecoTargetDir).Tools\Geco\%(RecursiveDir)\" OverwriteReadOnlyFiles="true" />
    <Exec Command="nuget pack Template\Template.nuspec" ConsoleToMSBuild="true"/>
  </Target>

  <Target BeforeTargets="BeforeBuild" Name="GecoCorePackage">
    <PropertyGroup>
      <GecoTargetDir1>$(ProjectDir)Geco.Core\contentFiles\any\netcoreapp2.0\</GecoTargetDir1>
      <GecoTargetDir2>$(ProjectDir)Geco.Core\content\</GecoTargetDir2>
    </PropertyGroup>

    <ItemGroup>
      <CoreFiles Include="$(GecoDir)appsettings.json" Condition="'$(OverwriteSettings)' == 'true'"/>
      <CoreFiles Include="$(GecoDir)**\*.cs" Exclude="$(GecoDir)obj\**\*.*"/>
      <CoreFiles Include="$(GecoDir)Program.cs" />
      <CoreFiles Remove="Database\**" />
    </ItemGroup>
    <Copy SourceFiles="@(CoreFiles)" DestinationFolder="$(GecoTargetDir1)%(RecursiveDir)\" OverwriteReadOnlyFiles="true" />
    <Copy SourceFiles="@(CoreFiles)" DestinationFolder="$(GecoTargetDir2)%(RecursiveDir)\" OverwriteReadOnlyFiles="true" />
    <Exec Command="nuget pack Geco.Core\Template.nuspec" ConsoleToMSBuild="true"/>
  </Target>

  <Target AfterTargets="AfterBuild" Name="CopyGecoPackages">
    <ItemGroup>
      <GecoPackages Include="*.nupkg" />
    </ItemGroup>

    <Copy SourceFiles="@(GecoPackages)" DestinationFolder="D:\Packages\" OverwriteReadOnlyFiles="true" />
  </Target>
  
</Project>